name: Multi-Platform Testing

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly to catch platform-specific issues
    - cron: '0 2 * * 1'

jobs:
  test-linux:
    name: Test on Linux Distributions
    runs-on: ubuntu-latest
    strategy:
      matrix:
        container:
          - ubuntu:22.04
          - ubuntu:20.04
          - fedora:39
          - debian:12
          
    container: ${{ matrix.container }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        if command -v apt-get >/dev/null 2>&1; then
          # Debian/Ubuntu
          apt-get update
          apt-get install -y curl jq docker.io bash
        elif command -v dnf >/dev/null 2>&1; then
          # Fedora
          dnf install -y curl jq docker bash
        elif command -v yum >/dev/null 2>&1; then
          # CentOS/RHEL
          yum install -y curl jq docker bash
        fi
        
    - name: Test script syntax
      run: |
        echo "ğŸ§ª Testing script syntax on ${{ matrix.container }}..."
        bash -n install-test-n8n-mcp-docker.sh
        echo "âœ… Script syntax validation passed"
        
    - name: Test basic functionality
      run: |
        echo "ğŸ§ª Testing basic functionality on ${{ matrix.container }}..."
        
        # Test JSON parsing
        echo '{"test": "value"}' | jq . >/dev/null
        echo "âœ… JSON parsing works"
        
        # Test curl functionality
        curl --version >/dev/null
        echo "âœ… Curl is functional"
        
        # Test bash features used in script
        bash -c 'declare -A test_array; test_array["key"]="value"; echo ${test_array["key"]}' >/dev/null
        echo "âœ… Bash associative arrays work"

  test-macos:
    name: Test on macOS
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        # Install required tools on macOS
        brew install jq
        
    - name: Test script syntax
      run: |
        echo "ğŸ§ª Testing script syntax on macOS..."
        bash -n install-test-n8n-mcp-docker.sh
        echo "âœ… Script syntax validation passed"
        
    - name: Test macOS compatibility
      run: |
        echo "ğŸ§ª Testing macOS compatibility..."
        
        # Test if script handles macOS-specific paths
        if [[ "$OSTYPE" == "darwin"* ]]; then
          echo "âœ… macOS detected correctly"
        fi
        
        # Test JSON parsing
        echo '{"test": "value"}' | jq . >/dev/null
        echo "âœ… JSON parsing works on macOS"

  test-windows:
    name: Test on Windows (WSL)
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up WSL
      uses: Vampire/setup-wsl@v2
      with:
        distribution: Ubuntu-22.04
        
    - name: Test in WSL environment
      shell: wsl-bash {0}
      run: |
        # Update package list
        sudo apt-get update
        sudo apt-get install -y curl jq
        
        echo "ğŸ§ª Testing script syntax in WSL..."
        bash -n install-test-n8n-mcp-docker.sh
        echo "âœ… Script syntax validation passed in WSL"
        
        # Test WSL-specific functionality
        echo "ğŸ§ª Testing WSL compatibility..."
        if grep -q "microsoft" /proc/version; then
          echo "âœ… WSL environment detected correctly"
        fi

  compatibility-test:
    name: Compatibility Testing
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Test Bash version compatibility
      run: |
        echo "ğŸ§ª Testing Bash version compatibility..."
        
        # Test with different Bash versions
        bash_versions=("4.4" "5.0" "5.1")
        
        for version in "${bash_versions[@]}"; do
          if command -v "bash-$version" >/dev/null 2>&1; then
            echo "Testing with Bash $version..."
            "bash-$version" -n install-test-n8n-mcp-docker.sh
            echo "âœ… Compatible with Bash $version"
          else
            echo "âš ï¸  Bash $version not available for testing"
          fi
        done
        
    - name: Test Docker version compatibility
      run: |
        echo "ğŸ§ª Testing Docker version compatibility..."
        
        # Test current Docker version
        docker --version
        
        # Test basic Docker functionality
        docker run --rm hello-world
        echo "âœ… Docker basic functionality works"
        
    - name: Test dependency availability
      run: |
        echo "ğŸ§ª Testing dependency availability..."
        
        required_commands=("curl" "jq" "docker" "bash" "grep" "sed" "awk")
        
        for cmd in "${required_commands[@]}"; do
          if command -v "$cmd" >/dev/null 2>&1; then
            echo "âœ… $cmd is available"
          else
            echo "âŒ $cmd is missing"
          fi
        done

  performance-test:
    name: Performance Testing
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Test script performance
      run: |
        echo "ğŸ§ª Testing script performance..."
        
        # Test script parsing time
        start_time=$(date +%s.%N)
        bash -n install-test-n8n-mcp-docker.sh
        end_time=$(date +%s.%N)
        parse_time=$(echo "$end_time - $start_time" | bc -l)
        
        echo "Script parsing time: ${parse_time}s"
        
        # Check if parsing time is reasonable (should be under 1 second)
        if (( $(echo "$parse_time < 1.0" | bc -l) )); then
          echo "âœ… Script parsing performance is good"
        else
          echo "âš ï¸  Script parsing is slow (${parse_time}s)"
        fi
        
    - name: Test memory usage
      run: |
        echo "ğŸ§ª Testing memory usage..."
        
        # Monitor memory usage during script syntax check
        /usr/bin/time -v bash -n install-test-n8n-mcp-docker.sh 2>&1 | grep "Maximum resident set size" || echo "âš ï¸  Memory usage data not available"

  integration-test:
    name: Integration Testing
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker
      uses: docker/setup-buildx-action@v3
      
    - name: Test Docker integration
      run: |
        echo "ğŸ§ª Testing Docker integration..."
        
        # Test if n8n-mcp image can be pulled
        docker pull ghcr.io/czlonkowski/n8n-mcp:latest || echo "âš ï¸  Image pull may be rate limited"
        
        # Test basic container functionality
        if docker images | grep -q "czlonkowski/n8n-mcp"; then
          echo "âœ… n8n-mcp image available"
          
          # Test container startup
          timeout 30s docker run --rm ghcr.io/czlonkowski/n8n-mcp:latest --help || echo "âš ï¸  Container test inconclusive"
        fi
        
    - name: Test MCP configuration
      run: |
        echo "ğŸ§ª Testing MCP configuration generation..."
        
        # Create test MCP configuration
        mkdir -p test-config
        cat > test-config/mcp-servers.json << 'EOF'
        {
          "mcpServers": {
            "n8n-mcp": {
              "command": "docker",
              "args": ["run", "-i", "--rm", "ghcr.io/czlonkowski/n8n-mcp:latest"],
              "env": {
                "MCP_MODE": "stdio"
              }
            }
          }
        }
        EOF
        
        # Validate configuration
        jq . test-config/mcp-servers.json >/dev/null
        echo "âœ… MCP configuration is valid JSON"
