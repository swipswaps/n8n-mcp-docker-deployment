#!/bin/bash
# Enhanced Trivy vulnerability scanning

set -euo pipefail

readonly TRIVY_VERSION="0.58.1"
readonly N8N_MCP_IMAGE="ghcr.io/czlonkowski/n8n-mcp:sha-df03d42"

echo "ğŸ›¡ï¸ Running comprehensive vulnerability scan..."

# Install Trivy if not available
if ! command -v trivy >/dev/null 2>&1; then
    echo "ğŸ“¦ Installing Trivy ${TRIVY_VERSION}..."
    curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v${TRIVY_VERSION}
fi

echo "ğŸ“‹ Trivy version: $(trivy --version)"

# Scan Docker image for vulnerabilities
echo "ğŸ” Scanning Docker image: $N8N_MCP_IMAGE"
trivy image \
    --severity HIGH,CRITICAL \
    --format table \
    --output trivy-image-report.txt \
    "$N8N_MCP_IMAGE"

# Scan filesystem for vulnerabilities
echo "ğŸ” Scanning filesystem for vulnerabilities..."
trivy fs \
    --severity HIGH,CRITICAL \
    --format table \
    --output trivy-fs-report.txt \
    .

# Generate SARIF report for GitHub
echo "ğŸ“Š Generating SARIF report for GitHub Actions..."
trivy image \
    --format sarif \
    --output trivy-results.sarif \
    "$N8N_MCP_IMAGE"

echo "âœ… Vulnerability scanning completed"
echo "ğŸ“‹ Reports generated:"
echo "  - trivy-image-report.txt (Docker image vulnerabilities)"
echo "  - trivy-fs-report.txt (Filesystem vulnerabilities)"
echo "  - trivy-results.sarif (GitHub Actions integration)"
